#!/bin/bash
set -e

cd /usr/share/bayeos-server
chmod +x *.sh
if ! id bayeos > /dev/null 2>&1 
then	
	useradd bayeos
fi
echo "Update database as postgres"
su - postgres -c /usr/share/bayeos-server/pg_postinst.sh
echo "Update database as bayeos"
java -jar liquibase.jar \
--driver=org.postgresql.Driver \
--classpath=postgresql-9.0-801.jdbc4.jar \
--changeLogFile=changelog.xml \
--url="jdbc:postgresql://localhost/bayeos" \
--username="bayeos" \
--password="4336bc9de7a6b11940e897ee22956d51" \
--defaultSchemaName="bayeos" \
update 2>&1

# Fix missing dirs which are referenced by catalina.properties
echo "Create Tomcat related stuff"
if [ ! -e /usr/share/tomcat7/shared/classes ] 
then
	mkdir -p /usr/share/tomcat7/shared/classes 
fi
if [ ! -e /usr/share/tomcat7/server/classes ] 
then
	mkdir -p /usr/share/tomcat7/server/classes 
fi

chown -R tomcat7 /usr/share/tomcat7
# This modifies a file of package tomcat7
cp /usr/share/bayeos-server/server-jk.xml /etc/tomcat7/server.xml
a2enmod jk
/etc/init.d/tomcat7 restart
/etc/init.d/apache2 restart
